#!/bin/bash
set -e

wait_for_service() {
    local host="$1"
    local port="$2"
    local service="$3"

    echo "Waiting for ${service} at ${host}:${port}..."
    while ! python -c "import socket; s=socket.socket(); s.settimeout(2); s.connect(('${host}', ${port})); s.close()" 2>/dev/null; do
        sleep 1
    done
    echo "${service} is ready."
}

wait_for_service "${REDIS_HOST:-redis}" "${REDIS_PORT:-6379}" "Redis"

echo "Starting Flower..."
exec celery -A {{ project_name }} flower \
    --port=5555 \
    --broker_api="${CELERY_BROKER_URL:-redis://redis:6379/1}"
