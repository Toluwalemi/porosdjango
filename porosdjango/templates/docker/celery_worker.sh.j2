#!/bin/bash
set -e

wait_for_service() {
    local host="$1"
    local port="$2"
    local service="$3"

    echo "Waiting for ${service} at ${host}:${port}..."
    while ! python -c "import socket; s=socket.socket(); s.settimeout(2); s.connect(('${host}', ${port})); s.close()" 2>/dev/null; do
        sleep 1
    done
    echo "${service} is ready."
}

wait_for_service "${POSTGRES_HOST:-db}" "${POSTGRES_PORT:-5432}" "PostgreSQL"
wait_for_service "${REDIS_HOST:-redis}" "${REDIS_PORT:-6379}" "Redis"

CELERY_CMD="celery -A {{ django_module }} worker --loglevel=${CELERY_LOG_LEVEL:-info} --concurrency=${CELERY_CONCURRENCY:-2}"

if [ "${DJANGO_DEBUG:-false}" = "true" ] || [ "${DJANGO_DEBUG:-false}" = "True" ] || [ "${DJANGO_DEBUG:-false}" = "1" ]; then
    echo "Starting Celery worker with auto-reload (watchfiles)..."
    exec watchfiles --filter python "${CELERY_CMD}"
else
    echo "Starting Celery worker..."
    exec ${CELERY_CMD}
fi
